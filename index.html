<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC断面計算（4断面一括）Ver.6.1</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap');
        
        :root {
            --primary-color: #2563eb;
            --border-color: #e2e8f0;
            --bg-canvas: #f8fafc;
        }

        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-canvas); 
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-mono { font-family: 'Roboto Mono', monospace; }

        /* 入力フィールドのカスタマイズ */
        .input-bare {
            width: 100%;
            background-color: transparent;
            border-bottom: 1px solid #cbd5e1;
            font-family: 'Roboto Mono', monospace;
            padding: 1px 2px;
            font-size: 13px;
            text-align: right; 
            transition: color 0.15s, border-color 0.15s, background-color 0.15s;
        }
        .input-bare:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: rgba(239, 246, 255, 0.5);
        }
        
        /* ラベルのスタイル */
        .label-sm {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* セクション見出しと区切り線 */
        .section-separator {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #cbd5e1;
        }
        .section-title {
            font-size: 11px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* 結果表示の行スタイル */
        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            line-height: 1.25;
        }

        /* 数式表示用スタイル */
        .formula-box {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            overflow-x: auto;
            font-family: 'Times New Roman', 'Noto Serif JP', serif;
        }
        .math-text { font-family: 'Times New Roman', serif; font-style: italic; }
        .math-normal { font-style: normal; }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 4px; font-size: 0.95em; }
        .numerator { border-bottom: 1px solid currentColor; padding: 0 2px; width: 100%; text-align: center; line-height: 1.2; }
        .denominator { padding: 0 2px; width: 100%; text-align: center; line-height: 1.2; }
        .sqrt-symbol { font-size: 1.2em; vertical-align: middle; }
        .sqrt-bar { border-top: 1px solid currentColor; padding-top: 1px; margin-left: 1px; display: inline-block; vertical-align: middle; }

        /* --- 修正: 印刷設定 --- */
        @media print {
            /* 1. 全要素のリセット設定 (最優先) */
            * {
                visibility: visible !important;
                overflow: visible !important; /* 全てのはみ出しを許可 */
                -webkit-print-color-adjust: exact !important; /* 背景色を強制出力 */
                print-color-adjust: exact !important;
            }

            /* 2. 不要なUIの完全非表示 */
            header, .no-print, #help_modal, #history_modal, .btn-tool {
                display: none !important;
                height: 0 !important;
                width: 0 !important;
            }

            /* 3. ページ設定 */
            @page {
                size: A4 portrait;
                margin: 5mm;
            }

            /* 4. 親要素の幅固定と縮小 */
            html, body {
                width: 900px !important;      /* 4列を詰めて配置するための基本幅 */
                min-width: 900px !important; 
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background-color: white !important;
                display: block !important;
                
                zoom: 1.00 !important;        /* 100% (等倍) */
            }

            /* 5. メインコンテナのレイアウト (余白調整) */
            main {
                margin: 0 !important;
                /* 左パディング: 15mm */
                padding: 35mm 0 0 15mm !important;
                width: 100% !important;
            }

            #sections_container {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;   /* 折り返し禁止 */
                justify-content: flex-start !important;
                align-items: flex-start !important;
                gap: 4px !important;            /* 隙間 */
                width: 100% !important;
            }

            /* 6. カードスタイルの保持 */
            .section-card {
                width: auto !important;
                flex: 1 1 0 !important;         /* 均等割り */
                min-width: 0 !important;
                margin: 0 !important;
                padding: 2px !important;
                border: 1px solid #333 !important;
                box-shadow: none !important;
                break-inside: avoid;
                background: white !important;
                transform: none !important;     /* transformは使用しない */
            }

            /* 入力欄の見た目調整（枠線を消す等） */
            .card-header {
                border-bottom: 1px solid #000 !important;
                background: none !important;
                padding: 2px 0 !important;
            }
            .card-header input {
                border: none !important;
                font-weight: bold !important;
                color: #000 !important;
                font-size: 11pt !important;
            }
            
            /* 入力値のフォントサイズ: 10pt */
            .input-bare, input[type="number"] {
                border: none !important;
                border-bottom: 0.5px solid #ccc !important;
                font-size: 10pt !important;
            }

            /* Select要素（鉄筋径など）の表示崩れ防止 */
            select {
                border: none !important;
                border-bottom: 0.5px solid #ccc !important;
                font-size: 10pt !important;
                /* 矢印を消して幅を確保 */
                appearance: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                width: auto !important; /* 文字数に合わせて幅を自動調整 */
                min-width: 30px !important; /* 最低幅を確保 */
                padding-right: 0 !important;
                text-align: right;
            }
            
            /* タイトルフォントを11ptに */
            .section-title {
                margin-bottom: 1mm !important; 
                font-size: 11pt !important; 
                color: #000 !important; 
            }
            
            /* 計算結果の発生応力数値を10ptに */
            .result-value-print {
                font-size: 10pt !important;
            }

            /* 色調整 */
            .text-slate-500, .text-slate-600, .text-slate-700, .text-blue-600, .text-red-500, .text-green-600 {
                color: #000 !important;
            }
            
            /* 区切り線 */
            .section-separator {
                margin-top: 4px !important;
                padding-top: 2px !important;
                border-top: 0.5px solid #000 !important;
            }
        }

        /* 画面表示用のカードスタイル */
        .section-card {
            width: 230px;
            flex-shrink: 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        /* ボタンスタイル（@apply代替） */
        .btn-secondary {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem; font-weight: 500;
            color: #475569; background-color: white;
            border: 1px solid #e2e8f0; border-radius: 0.375rem;
            transition: all 0.15s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover { background-color: #f8fafc; color: #2563eb; }
        
        .btn-primary {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem; font-weight: 700;
            color: white; background-color: #2563eb;
            border-radius: 0.375rem;
            transition: all 0.15s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover { background-color: #1d4ed8; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>

    <!-- ヘッダー -->
    <header class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-slate-200 px-6 py-3 flex items-center justify-between shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-600 rounded-lg text-white shadow-md">
                <i data-lucide="calculator" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight">RC断面計算 <span class="text-xs font-normal text-slate-500 ml-1 bg-slate-100 px-2 py-0.5 rounded-full border border-slate-200">Ver.6.1</span></h1>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleHistory(true)" class="btn-secondary text-slate-600"><i data-lucide="history" class="w-4 h-4"></i> 更新履歴</button>
            <button onclick="toggleHelp(true)" class="btn-secondary text-slate-600"><i data-lucide="help-circle" class="w-4 h-4"></i> ヘルプ・計算式</button>
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <button onclick="saveData()" class="btn-secondary"><i data-lucide="save" class="w-4 h-4"></i> 保存</button>
            <label class="btn-secondary cursor-pointer">
                <i data-lucide="upload" class="w-4 h-4"></i> 読込
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="loadData(this)">
            </label>
            <button onclick="window.print()" class="btn-primary"><i data-lucide="printer" class="w-4 h-4"></i> 印刷</button>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="p-6 overflow-x-auto min-h-[calc(100vh-80px)]">
        <!-- Flex Container: 画面では横並び、印刷ではGrid(1行4列) -->
        <div id="sections_container" class="flex flex-wrap gap-4 justify-center items-start mx-auto w-full">
            <!-- JSでカードを描画 -->
        </div>
    </main>

    <!-- ヘルプモーダル -->
    <div id="help_modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="book-open" class="w-5 h-5 text-blue-600"></i> 計算式・ユーザーマニュアル</h3>
                <button onclick="toggleHelp(false)" class="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-8 overflow-y-auto text-slate-700 text-sm leading-relaxed space-y-8">

                <!-- 1. ユーザーマニュアル -->
                <section>
                    <h4 class="text-lg font-bold text-slate-800 border-l-4 border-blue-600 pl-3 mb-4">1. ユーザーマニュアル (User Manual)</h4>
                    
                    <div class="space-y-4">
                        <div>
                            <h5 class="font-bold text-slate-700 text-sm mb-1">■ 基本的な使い方</h5>
                            <p class="text-xs text-slate-600 leading-relaxed">
                                このツールは4つの断面について同時にRC（鉄筋コンクリート）断面計算を行い、応力度と許容値を比較します。<br>
                                入力値を変更すると、即座に計算結果が再計算され、右側の図と下部の結果欄に反映されます。<br>
                                計算結果が許容値を超えると<span class="text-red-600 font-bold bg-red-100 px-1 rounded">NG</span>、範囲内であれば<span class="text-blue-600 font-bold bg-blue-100 px-1 rounded">OK</span>と表示されます。
                            </p>
                        </div>

                        <div>
                            <h5 class="font-bold text-slate-700 text-sm mb-1">■ 入力項目について</h5>
                            <ul class="list-disc list-inside text-xs text-slate-600 leading-relaxed pl-2 space-y-1">
                                <li><strong>材料条件:</strong> コンクリート強度(Fc)や鉄筋種別を選択します。許容応力度やヤング係数比(n)は自動設定されますが、任意の値に書き換えることも可能です。割増係数(α)は短期荷重時などに変更してください。</li>
                                <li><strong>断面形状:</strong> 部材の幅(b)、高さ(h)、引張鉄筋中心までの距離(dt)、圧縮鉄筋中心までの距離(dp)をミリメートル単位で入力します。</li>
                                <li><strong>配筋:</strong> 鉄筋径と本数を選択・入力します。「As」は引張側、「As'」は圧縮側です。括弧内の数値は1メートルあたりの断面積(mm²/m)に換算された値です。</li>
                                <li><strong>断面力:</strong> 設計用の曲げモーメント(M)、軸力(N)、せん断力(S)を入力します。<strong>これらは部材幅1メートルあたりの値（kN・m/m, kN/m）として入力してください。</strong></li>
                            </ul>
                            <p class="text-xs text-slate-500 mt-2 pl-2">※ 断面タイトルは全角文字も使用できますが、それ以外の数値入力欄は<strong>半角数字</strong>を使用してください。</p>
                        </div>

                        <div>
                            <h5 class="font-bold text-slate-700 text-sm mb-1">■ 便利機能</h5>
                            <ul class="list-disc list-inside text-xs text-slate-600 leading-relaxed pl-2 space-y-1">
                                <li><strong>コピー機能 <i data-lucide="copy" class="w-3 h-3 inline"></i>:</strong> 断面2～4のタイトル右にあるコピーボタンを押すと、断面1の入力データ（材料・形状・配筋）がその断面にコピーされます。断面力はコピーされません。</li>
                                <li><strong>保存/読込:</strong> ヘッダーの「保存」ボタンで現在の入力状態をJSONファイルとしてダウンロードできます。「読込」ボタンで保存したファイルを復元できます。</li>
                                <li><strong>印刷:</strong> 「印刷」ボタンを押すと、A4縦用紙に4つの断面が1行4列で配置されるレイアウトで印刷できます。比較資料の作成に便利です。</li>
                            </ul>
                        </div>
                    </div>
                </section>
                
                <!-- 2. 曲げ応力度 -->
                <section>
                    <h4 class="text-lg font-bold text-slate-800 border-l-4 border-blue-600 pl-3 mb-4">2. 曲げ応力度 (Bending Stress)</h4>
                    
                    <!-- 基本原理の図解と説明 -->
                    <div class="mb-8 bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                        <h5 class="font-bold text-slate-700 text-base mb-4 flex items-center gap-2">
                            <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
                            基本原理：平面保持の法則と力の釣り合い
                        </h5>
                        
                        <!-- 図解エリア (SVG) -->
                        <div class="flex justify-center mb-6 overflow-x-auto">
                            <svg width="500" height="200" viewBox="0 0 500 200" class="bg-slate-50 rounded border border-slate-100">
                                <!-- 矢印マーカー定義 -->
                                <defs>
                                    <marker id="arrowHead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="#475569" />
                                    </marker>
                                    <marker id="arrowHeadBlue" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="#2563eb" />
                                    </marker>
                                    <marker id="arrowHeadRed" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626" />
                                    </marker>
                                </defs>

                                <!-- 1. 断面図 (Left) -->
                                <g transform="translate(40, 30)">
                                    <text x="35" y="-10" text-anchor="middle" font-size="12" font-weight="bold" fill="#475569">断面</text>
                                    <rect x="0" y="0" width="70" height="150" fill="#e2e8f0" stroke="#334155" stroke-width="2"/>
                                    <!-- 鉄筋: 修正 (圧縮鉄筋のみどり丸削除) -->
                                    <circle cx="35" cy="120" r="5" fill="#ef4444" stroke="#7f1d1d" stroke-width="1"/> <!-- 引張鉄筋 -->
                                    
                                    <!-- 寸法線 d -->
                                    <line x1="80" y1="0" x2="80" y2="120" stroke="#64748b" stroke-width="1" />
                                    <line x1="75" y1="0" x2="85" y2="0" stroke="#64748b" stroke-width="1" />
                                    <line x1="75" y1="120" x2="85" y2="120" stroke="#64748b" stroke-width="1" />
                                    <text x="90" y="65" font-family="Times New Roman" font-style="italic" font-size="14" fill="#64748b">d</text>
                                </g>

                                <!-- 2. ひずみ分布 (Middle) -->
                                <g transform="translate(180, 30)">
                                    <text x="50" y="-10" text-anchor="middle" font-size="12" font-weight="bold" fill="#475569">ひずみ分布</text>
                                    <!-- 基準線 -->
                                    <line x1="50" y1="0" x2="50" y2="150" stroke="#cbd5e1" stroke-width="1.5" stroke-dasharray="4,2"/>
                                    <!-- 中立軸 (y=50) -->
                                    <line x1="-10" y1="50" x2="110" y2="50" stroke="#94a3b8" stroke-dasharray="2,2"/>
                                    <text x="115" y="53" font-size="10" fill="#94a3b8">中立軸</text>

                                    <!-- ひずみ線 (修正: 交点(50, 50)を通るように) -->
                                    <!-- 上端(y=0)を x=85 とすると dx=35(50-85=-35) for dy=50. -->
                                    <!-- 下端(y=150)は dy=100. dx = -35 * (100/50) = -70. x = 50 - 70 = -20 -->
                                    <line x1="85" y1="0" x2="-20" y2="150" stroke="#334155" stroke-width="2"/>

                                    <!-- 圧縮ひずみ εc (修正: x1=50, x2=85) -->
                                    <line x1="50" y1="0" x2="82" y2="0" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrowHeadBlue)"/>
                                    <text x="88" y="5" font-family="Times New Roman" font-style="italic" font-size="14" fill="#2563eb">ε<tspan dy="2" font-size="10">c</tspan></text>

                                    <!-- 引張ひずみ εs (修正: 鉄筋位置 y=120) -->
                                    <!-- y=120のとき dy=70. dx = -35 * (70/50) = -49. x = 50 - 49 = 1 -->
                                    <line x1="50" y1="120" x2="4" y2="120" stroke="#dc2626" stroke-width="1.5" marker-end="url(#arrowHeadRed)"/>
                                    <text x="0" y="125" text-anchor="end" font-family="Times New Roman" font-style="italic" font-size="14" fill="#dc2626">ε<tspan dy="2" font-size="10">s</tspan></text>
                                    
                                    <!-- x寸法 -->
                                    <line x1="30" y1="0" x2="30" y2="50" stroke="#64748b" stroke-width="1"/>
                                    <text x="20" y="30" text-anchor="end" font-family="Times New Roman" font-style="italic" font-size="14" fill="#64748b">x</text>
                                </g>

                                <!-- 3. 応力分布 (Right) -->
                                <g transform="translate(340, 30)">
                                    <text x="50" y="-10" text-anchor="middle" font-size="12" font-weight="bold" fill="#475569">応力分布・内力</text>
                                    <line x1="50" y1="0" x2="50" y2="150" stroke="#cbd5e1" stroke-width="1.5"/>
                                    
                                    <!-- 圧縮応力ブロック (三角形) -->
                                    <path d="M50,50 L90,0 L50,0 Z" fill="#dbeafe" stroke="#2563eb" stroke-width="1"/>
                                    <!-- 圧縮合力 C -->
                                    <line x1="50" y1="16.6" x2="100" y2="16.6" stroke="#2563eb" stroke-width="2.5" marker-end="url(#arrowHeadBlue)"/>
                                    <text x="110" y="20" font-family="Times New Roman" font-style="italic" font-size="16" font-weight="bold" fill="#2563eb">C</text>

                                    <!-- 引張合力 T -->
                                    <line x1="50" y1="120" x2="0" y2="120" stroke="#dc2626" stroke-width="2.5" marker-end="url(#arrowHeadRed)"/>
                                    <text x="-10" y="125" text-anchor="end" font-family="Times New Roman" font-style="italic" font-size="16" font-weight="bold" fill="#dc2626">T</text>
                                    
                                    <!-- 応力中心間距離 j -->
                                    <line x1="75" y1="16.6" x2="75" y2="120" stroke="#64748b" stroke-width="1" />
                                    <line x1="72" y1="16.6" x2="78" y2="16.6" stroke="#64748b" stroke-width="1" />
                                    <line x1="72" y1="120" x2="78" y2="120" stroke="#64748b" stroke-width="1" />
                                    <text x="82" y="65" font-family="Times New Roman" font-style="italic" font-size="14" fill="#64748b">j</text>
                                    <text x="82" y="78" font-size="9" fill="#64748b">(応力中心距離)</text>
                                </g>
                            </svg>
                        </div>

                        <!-- 解説テキスト -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-slate-700">
                            <div>
                                <h6 class="font-bold text-blue-600 mb-2 border-b border-blue-100 pb-1">① 平面保持の法則 (適合条件)</h6>
                                <p class="text-xs leading-relaxed mb-2">
                                    「変形後も断面は平面を保つ」という仮定です。これにより、コンクリートや鉄筋の<strong>ひずみ（<span class="math-text">&epsilon;</span>）は中立軸からの距離に比例</strong>します。
                                </p>
                                <div class="bg-slate-50 p-2 rounded text-center mb-2">
                                    <span class="math-text text-lg">
                                        <div class="fraction"><span class="numerator">&epsilon;<sub>c</sub></span><span class="denominator">x</span></div>
                                        =
                                        <div class="fraction"><span class="numerator">&epsilon;<sub>s</sub></span><span class="denominator">d - x</span></div>
                                    </span>
                                </div>
                                <p class="text-xs leading-relaxed text-slate-500">
                                    この幾何学的な三角形の相似関係から、鉄筋とコンクリートの応力の関係式が導かれます。
                                </p>
                            </div>

                            <div>
                                <h6 class="font-bold text-red-600 mb-2 border-b border-red-100 pb-1">② 力の釣り合い (平衡条件)</h6>
                                <p class="text-xs leading-relaxed mb-2">
                                    断面に作用する「外力」と、内部で抵抗する「内力」の総和はゼロになります。
                                </p>
                                <ul class="list-disc list-inside text-xs space-y-1 pl-1">
                                    <li><strong>力の釣り合い (N=0の場合):</strong> <br>圧縮合力 <span class="math-text">C</span> = 引張合力 <span class="math-text">T</span></li>
                                    <li><strong>モーメントの釣り合い:</strong> <br>外力モーメント <span class="math-text">M</span> = 偶力 <span class="math-text">C &sdot; j</span> = <span class="math-text">T &sdot; j</span></li>
                                </ul>
                                <div class="bg-slate-50 p-2 rounded text-center mt-2 flex justify-center gap-4">
                                    <span class="math-text">C = <div class="fraction"><span class="numerator">1</span><span class="denominator">2</span></div> b x &sigma;<sub>c</sub></span>
                                    <span class="math-text">T = A<sub>s</sub> &sigma;<sub>s</sub></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- 軸力あり -->
                        <div>
                            <h5 class="font-bold text-slate-700 border-b border-slate-300 pb-1 mb-2">A. 軸力がある場合 (<span class="math-text">N &ne; 0</span>)</h5>
                            <p class="text-xs mb-2">中立軸 <span class="math-text">x</span> は、以下の3次方程式の解として求められます。</p>
                            
                            <div class="formula-box text-center">
                                <span class="math-text">x<sup>3</sup> - 3L x<sup>2</sup> - <div class="fraction"><span class="numerator">6n</span><span class="denominator">b</span></div> [A'<sub>s</sub>(L-d<sub>p</sub>) + A<sub>s</sub>(L-d)] x + <div class="fraction"><span class="numerator">6n</span><span class="denominator">b</span></div> [A'<sub>s</sub>d<sub>p</sub>(L-d<sub>p</sub>) + A<sub>s</sub>d(L-d)] = 0</span>
                            </div>
                            <p class="text-[11px] text-slate-500 text-center mb-4">ここで、<span class="math-text">L = h/2 - e</span>, <span class="math-text">e = M/N</span></p>

                            <p class="text-xs mb-2">各応力度は以下の釣り合い式より算出します。</p>
                            <div class="formula-box grid gap-4">
                                <div class="text-center">
                                    <span class="text-xs font-bold mr-2">コンクリート圧縮:</span>
                                    <span class="math-text">&sigma;<sub>c</sub> = <div class="fraction"><span class="numerator">N</span><span class="denominator"><div class="fraction"><span class="numerator">bx</span><span class="denominator">2</span></div> + <div class="fraction"><span class="numerator">n A'<sub>s</sub>(x-d<sub>p</sub>)</span><span class="denominator">x</span></div> - <div class="fraction"><span class="numerator">n A<sub>s</sub>(d-x)</span><span class="denominator">x</span></div></span></div></span>
                                </div>
                                <div class="flex justify-center gap-8">
                                    <div>
                                        <span class="text-xs font-bold mr-2">鉄筋引張:</span>
                                        <span class="math-text">&sigma;<sub>s</sub> = n &sigma;<sub>c</sub> <div class="fraction"><span class="numerator">d-x</span><span class="denominator">x</span></div></span>
                                    </div>
                                    <div>
                                        <span class="text-xs font-bold mr-2">鉄筋圧縮:</span>
                                        <span class="math-text">&sigma;'<sub>s</sub> = n &sigma;<sub>c</sub> <div class="fraction"><span class="numerator">x-d<sub>p</sub></span><span class="denominator">x</span></div></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 純曲げ -->
                        <div>
                            <h5 class="font-bold text-slate-700 border-b border-slate-300 pb-1 mb-2">B. 純曲げの場合 (<span class="math-text">N &approx; 0</span>)</h5>
                            <p class="text-xs mb-2">中立軸比 <span class="math-text">k = x/d</span> は以下の式より求めます。</p>
                            
                            <div class="formula-box text-center">
                                <span class="math-text">k = <span class="sqrt-symbol">&radic;</span><span class="sqrt-bar">2n(p + p'<div class="fraction"><span class="numerator">d<sub>p</sub></span><span class="denominator">d</span></div>) + (n(p+p'))<sup>2</sup></span> - n(p+p')</span>
                            </div>
                            <p class="text-[11px] text-slate-500 text-center mb-4"><span class="math-text">p = A<sub>s</sub> / bd</span> , <span class="math-text">p' = A'<sub>s</sub> / bd</span></p>

                            <p class="text-xs mb-2">応力度は以下の式より算出します。</p>
                            <div class="formula-box grid gap-4">
                                <div class="flex justify-center gap-8">
                                    <div>
                                        <span class="text-xs font-bold mr-2">コンクリート:</span>
                                        <span class="math-text">&sigma;<sub>c</sub> = <div class="fraction"><span class="numerator">M</span><span class="denominator"><div class="fraction"><span class="numerator">1</span><span class="denominator">2</span></div> b d<sup>2</sup> k j</span></div></span>
                                    </div>
                                    <div>
                                        <span class="text-xs font-bold mr-2">鉄筋引張:</span>
                                        <span class="math-text">&sigma;<sub>s</sub> = <div class="fraction"><span class="numerator">M</span><span class="denominator">A<sub>s</sub> j d</span></div></span>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <span class="text-xs font-bold mr-2">鉄筋圧縮:</span>
                                    <span class="math-text">&sigma;'<sub>s</sub> = n &sigma;<sub>c</sub> <div class="fraction"><span class="numerator">x-d<sub>p</sub></span><span class="denominator">x</span></div></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 3. せん断応力度 -->
                <section>
                    <h4 class="text-lg font-bold text-slate-800 border-l-4 border-blue-600 pl-3 mb-4">3. せん断応力度 (Shear Stress)</h4>
                    <div class="formula-box">
                        <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold">発生値:</span>
                                <span class="math-text text-lg">&tau; = <div class="fraction"><span class="numerator">S</span><span class="denominator">b d</span></div></span>
                            </div>
                            <div class="flex items-center gap-4 border-t border-slate-300 pt-4 w-full justify-center">
                                <span class="text-xs font-bold">許容値:</span>
                                <span class="math-text text-lg">f<sub>a</sub> = &tau;<sub>a1</sub> &sdot; C<sub>e</sub> &sdot; C<sub>pt</sub> &sdot; &alpha;</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 ml-2">
                        ※ &tau;<sub>a1</sub>: コンクリート強度による基本値<br>
                        ※ C<sub>e</sub>, C<sub>pt</sub>: 補正係数 (0.7 ～ 1.5)<br>
                        ※ &alpha;: 割増係数
                    </p>

                    <!-- 詳細算定表 -->
                    <div class="mt-4 bg-slate-50 p-3 rounded border border-slate-200">
                        <h5 class="font-bold text-slate-700 text-xs mb-2">■ せん断許容応力度の算定詳細</h5>
                        
                        <p class="text-xs font-bold mt-2 mb-1">(1) コンクリートの許容せん断応力度 <span class="math-text">&tau;<sub>a1</sub></span> (N/mm²)</p>
                        <table class="w-full text-xs text-center border-collapse border border-slate-300 mb-2">
                            <tr class="bg-slate-200"><th class="border border-slate-300 p-1">Fc</th><td>18</td><td>21</td><td>24</td><td>27</td><td>30</td><td>40</td><td>50</td></tr>
                            <tr><th class="border border-slate-300 p-1"><span class="math-text">&tau;<sub>a1</sub></span></th><td>0.21</td><td>0.22</td><td>0.23</td><td>0.24</td><td>0.25</td><td>0.29</td><td>0.31</td></tr>
                        </table>

                        <p class="text-xs font-bold mt-2 mb-1">(2) 部材高さによる補正係数 <span class="math-text">C<sub>e</sub></span></p>
                        <div class="formula-box text-center py-2 my-1">
                            <span class="math-text">C<sub>e</sub> = <sup style="font-size:0.7em">4</sup><span class="sqrt-symbol">&radic;</span><span class="sqrt-bar"><div class="fraction"><span class="numerator">1000</span><span class="denominator">d</span></div></span></span>
                            <span class="text-xs text-slate-500 ml-2">(0.7 &le; <span class="math-text">C<sub>e</sub></span> &le; 1.5)</span>
                        </div>
                        <table class="w-full text-xs text-center border-collapse border border-slate-300 mb-2">
                            <tr class="bg-slate-200"><th class="border border-slate-300 p-1">d (mm)</th><td>&le;300</td><td>1000</td><td>3000</td><td>&ge;5000</td></tr>
                            <tr><th class="border border-slate-300 p-1"><span class="math-text">C<sub>e</sub></span></th><td>1.35</td><td>1.00</td><td>0.76</td><td>0.67</td></tr>
                        </table>

                        <p class="text-xs font-bold mt-2 mb-1">(3) 引張鉄筋比による補正係数 <span class="math-text">C<sub>pt</sub></span></p>
                        <div class="formula-box text-center py-2 my-1">
                            <span class="math-text">C<sub>pt</sub> = <sup style="font-size:0.7em">3</sup><span class="sqrt-symbol">&radic;</span><span class="sqrt-bar">100 &sdot; p<sub>t</sub></span></span>
                            <span class="text-xs text-slate-500 ml-2">(0.7 &le; <span class="math-text">C<sub>pt</sub></span> &le; 1.5)</span>
                        </div>
                        <div class="text-[10px] text-slate-500 ml-2 mb-2">※ <span class="math-text">p<sub>t</sub></span> は引張鉄筋比 (%) = <span class="math-text"><div class="fraction"><span class="numerator">A<sub>s</sub></span><span class="denominator">b &sdot; d</span></div> &times; 100</span></div>
                    </div>
                </section>

                <div class="text-center pt-8">
                    <button onclick="toggleHelp(false)" class="px-8 py-2.5 bg-slate-800 text-white rounded font-bold hover:bg-slate-700 transition shadow-lg">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 履歴モーダル -->
    <div id="history_modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i data-lucide="history" class="w-5 h-5 text-blue-600"></i> バージョンアップ履歴</h3>
                <button onclick="toggleHistory(false)" class="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-slate-700 text-sm leading-relaxed space-y-4">
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.6.1 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>断面図の鉄筋径表示を断面寸法の縮尺と完全に一致するように修正（最小表示サイズの撤廃）</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.6.0 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>Fc=40の許容曲げ圧縮応力度を13.0から14.0に修正</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.9 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>図解修正：断面図の圧縮鉄筋を削除（単鉄筋モデル）</li>
                        <li>図解修正：ひずみ分布図の斜線が中立軸交点を正確に通るよう再計算</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.8 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>ヘルプファイル：ユーザーマニュアルを最上部に移動</li>
                        <li>ヘルプファイル：数式表現をHTML形式に統一</li>
                        <li>図解修正：ひずみ分布図のεc矢印をコンクリート上面に合わせるよう調整</li>
                        <li>図解修正：応力分布図に「j (応力中心距離)」の説明を追加</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.7 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>ヘルプファイルに「基本原理と仮定（ひずみ分布図・平面保持の法則・力の釣り合い）」の詳細解説と高精細図解を追加</li>
                        <li>配筋入力欄に引張鉄筋比(pt)の表示を追加</li>
                        <li>ヘルプファイル内の数式表示を改善</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.6 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>ヘルプファイルに「基本原理と仮定（ひずみ分布図・平面保持の法則・力の釣り合い）」の説明を追加</li>
                        <li>配筋入力欄に引張鉄筋比(pt)の表示を追加</li>
                        <li>ヘルプファイル内の数式表示を改善</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.5 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>ヘルプファイルの数式表示を改善（LaTeX記法廃止）</li>
                        <li>配筋入力欄に引張鉄筋比(pt)の表示を追加</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.4 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>印刷時のタイトルフォント(11pt)と計算結果フォント(10pt)を調整</li>
                        <li>ヘルプファイルにせん断応力度の算定表を追加</li>
                        <li>ヘルプボタンの色を統一</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.3 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>印刷時の鉄筋本数などのフォントサイズを拡大 (10pt)</li>
                        <li>更新履歴機能の追加</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.2 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>印刷時の全体的なフォントサイズ拡大 (断面名11pt, 入力値10pt)</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.1 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>断面2～4の初期状態を空欄に変更</li>
                        <li>入力がない断面の計算結果を非表示にするよう修正</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.5.0 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>印刷時の鉄筋径表示修正（プルダウンの桁落ち対応）</li>
                        <li>印刷レイアウトの左余白を微調整</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.4.x (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>印刷プレビューが白紙になる問題を修正（Zoom方式の実装）</li>
                        <li>印刷レイアウトをA4縦1行4列に最適化</li>
                        <li>印刷余白・縮小率の調整</li>
                    </ul>
                </div>
                <div class="border-b border-slate-100 pb-4">
                    <h5 class="font-bold text-slate-800">Ver.3.7 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>断面力の入力単位を「部材幅1mあたり」に変更</li>
                        <li>マニュアルの記載更新</li>
                    </ul>
                </div>
                <div>
                    <h5 class="font-bold text-slate-800">Ver.3.6 (2026-02-07)</h5>
                    <ul class="list-disc list-inside text-xs text-slate-600 pl-2 mt-1">
                        <li>ベースバージョンの作成</li>
                    </ul>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 text-center">
                <button onclick="toggleHistory(false)" class="px-6 py-2 bg-white border border-slate-300 text-slate-700 rounded font-bold hover:bg-slate-50 transition">閉じる</button>
            </div>
        </div>
    </div>

    <!-- 計算ロジック・定数定義 -->
    <script>
        lucide.createIcons();

        // --- 定数データ ---
        const REBAR_AREAS = {
            "D10": 71.33, "D13": 126.7, "D16": 198.6, "D19": 286.5,
            "D22": 387.1, "D25": 506.7, "D29": 642.4, "D32": 794.2,
            "D35": 956.6, "D38": 1140, "D41": 1340,
            "φ9": 63.6, "φ13": 132.7, "φ16": 201.1, "φ19": 283.5, "φ22": 380.1, "φ25": 490.9
        };

        const CONCRETE_DATA = {
            18: { sigCa: 6.0, tauA1: 0.21 }, 21: { sigCa: 7.0, tauA1: 0.22 }, 24: { sigCa: 8.0, tauA1: 0.23 },
            27: { sigCa: 9.0, tauA1: 0.24 }, 30: { sigCa: 10.0, tauA1: 0.25 }, 40: { sigCa: 14.0, tauA1: 0.29 }, // 修正箇所: 13.0 -> 14.0
            50: { sigCa: 16.0, tauA1: 0.31 }
        };

        const REBAR_DATA = {
            "SD295": { sigSa: 180, name: "SD295A/B" },
            "SD345": { sigSa: 180, name: "SD345" }, 
            "SD345_200": { sigSa: 200, name: "SD345(200)" },
            "SR235": { sigSa: 140, name: "SR235" }
        };

        const DEFAULT_SECTION = {
            name: "断面検討",
            b: 1000, D: 300, dt: 60, dp: 60,
            barSizeT: "D13", barCountT: 8, manualAs: null,
            barSizeC: "D13", barCountC: 4, manualAsp: null,
            N_kN: 0, M_kNm: 20, S_kN: 15,
            n: 15, Fc: 24, 
            rebarType: "SD345", 
            userSigSa: 180, 
            allowFactor: 1.00
        };

        // --- 修正: 初期化ロジックの変更 (断面2-4は空にする) ---
        let sections = [
            { ...DEFAULT_SECTION, name: "断面-1" },
            { 
                ...DEFAULT_SECTION, name: "断面-2", 
                b: null, D: null, dt: null, dp: null, 
                barCountT: null, barCountC: null, 
                N_kN: null, M_kNm: null, S_kN: null, 
                userSigSa: null, allowFactor: null 
            },
            { 
                ...DEFAULT_SECTION, name: "断面-3", 
                b: null, D: null, dt: null, dp: null, 
                barCountT: null, barCountC: null, 
                N_kN: null, M_kNm: null, S_kN: null, 
                userSigSa: null, allowFactor: null 
            },
            { 
                ...DEFAULT_SECTION, name: "断面-4", 
                b: null, D: null, dt: null, dp: null, 
                barCountT: null, barCountC: null, 
                N_kN: null, M_kNm: null, S_kN: null, 
                userSigSa: null, allowFactor: null 
            }
        ];

        // --- 計算関数 ---
        function calculateRC(s) {
            // --- 修正: 必須入力チェック (入力がなければ空の結果を返す) ---
            if (!s.b || !s.D) {
                return { 
                    state: 'empty', // 空の状態を示すフラグ
                    x: 0, sigma_c: 0, sigma_s: 0, sigma_sp: 0, 
                    tau: 0, fa: 0, Ce: 1, Cpt: 1, 
                    allow_sigC: 0, allow_sigS: 0, allow_tauA1_base: 0,
                    shearState: '', bendStateC: '', bendStateS: '',
                    msg: '', As_per_meter: 0, Asp_per_meter: 0, d: 0,
                    ptPerc: 0
                };
            }

            const conc = CONCRETE_DATA[s.Fc] || CONCRETE_DATA[24];
            const f = s.allowFactor || 1.0;

            const allow_sigC = conc.sigCa * f;
            const allow_sigS = (s.userSigSa || 180) * f;
            const allow_tauA1_base = conc.tauA1 * f;

            const CALC_B = 1000.0;
            const width_ratio = CALC_B / s.b;

            const d = s.D - s.dt;
            const dp = s.dp;
            const n = s.n;

            // 入力された本数から断面積を計算
            const As_input_total = (REBAR_AREAS[s.barSizeT] || 0) * (s.barCountT || 0); // null対策
            const Asp_input_total = (REBAR_AREAS[s.barSizeC] || 0) * (s.barCountC || 0); // null対策

            // 計算用（単位幅1000mm換算）の断面積
            const As = As_input_total * width_ratio;
            const Asp = Asp_input_total * width_ratio;
            
            // 表示用（1mあたりの断面積）
            const As_per_meter = As;
            const Asp_per_meter = Asp;
            
            // 入力値は既に1mあたりの値 (kN/m, kN-m/m) とするので、単位換算(kN->N, m->mm)のみ行う
            const N_val = (s.N_kN || 0) * 1000.0;      
            const M_val = (s.M_kNm || 0) * 1000000.0;
            const S_val = (s.S_kN || 0) * 1000.0;      

            const b = CALC_B;

            let res = { 
                x: 0, sigma_c: 0, sigma_s: 0, sigma_sp: 0, 
                tau: 0, fa: 0, Ce: 1, Cpt: 1, 
                allow_sigC, allow_sigS, allow_tauA1_base,
                shearState: 'ok', bendStateC: 'ok', bendStateS: 'ok',
                state: 'ok', msg: '', As_per_meter, Asp_per_meter, d,
                ptPerc: 0
            };

            try {
                // --- 修正: pt計算 ---
                const pt = As / (b * d);
                res.ptPerc = pt * 100;

                const EPS_N = 1e-6 * Math.max(Math.abs(N_val), 1.0);
                let x = null;

                if (Math.abs(N_val) < EPS_N) { // 純曲げ
                    const p = As / (b * d);
                    const pp = Asp / (b * d);
                    const t1 = 2 * n * (p + pp * dp / d);
                    const t2 = Math.pow(n * (p + pp), 2);
                    const k = Math.sqrt(t1 + t2) - n * (p + pp);
                    x = k * d;
                    res.x = x;
                    const num_j = Math.pow(k, 2) * (1 - k/3.0) + 2 * n * pp * (k - dp/d) * (1 - dp/d);
                    const den_j = Math.pow(k, 2) + 2 * n * pp * (k - dp/d);
                    const j_val = num_j / den_j;
                    const Lc = (k / 2.0) * (1 - k/3.0) + (n * pp / k) * (k - dp/d) * (1 - dp/d);
                    res.sigma_c = M_val / (b * Math.pow(d, 2) * Lc);
                    res.sigma_sp = (Math.abs(x) < 1e-9) ? 0 : n * res.sigma_c * (x - dp) / x;
                    res.sigma_s = M_val / (As * j_val * d);
                } else { // 軸力あり
                    const L = s.D / 2.0 - M_val / N_val;
                    const Coef1 = (6.0 * n / b) * (Asp * (L - dp) + As * (L - d));
                    const Coef2 = (6.0 * n / b) * (Asp * dp * (L - dp) + As * d * (L - d));
                    const F = (v) => Math.pow(v, 3) - 3 * L * Math.pow(v, 2) - Coef1 * v + Coef2;
                    const dF = (v) => 3 * Math.pow(v, 2) - 6 * L * v - Coef1;
                    x = 0.4 * d;
                    for(let i=0; i<100; i++) {
                        const fx = F(x);
                        const dfx = dF(x);
                        if(Math.abs(dfx) < 1e-12) break;
                        const nx = x - fx/dfx;
                        if(Math.abs(nx - x) < 1e-6) { x = nx; break; }
                        x = nx;
                    }
                    res.x = x;
                    const denom = 0.5 * b * x + n * Asp * (x - dp) / x - n * As * (d - x) / x;
                    if (Math.abs(denom) < 1e-9) throw new Error("denom≒0");
                    res.sigma_c = N_val / denom;
                    res.sigma_sp = (Math.abs(x) < 1e-5) ? 0 : n * res.sigma_c * (x - dp) / x;
                    res.sigma_s = (Math.abs(x) < 1e-5) ? 0 : n * res.sigma_c * (d - x) / x;
                }
                
                if(res.x <= 0 || res.x >= d) { res.state = 'warn'; res.msg = '全断面圧縮等'; }

                res.bendStateC = (Math.abs(res.sigma_c) <= allow_sigC) ? 'ok' : 'ng';
                res.bendStateS = (Math.abs(res.sigma_s) <= allow_sigS) ? 'ok' : 'ng'; 

                res.tau = S_val / (b * d);  
                let ce_val = Math.pow(1000.0 / d, 0.25);
                if (ce_val < 0.7) ce_val = 0.7; else if (ce_val > 1.5) ce_val = 1.5;
                res.Ce = ce_val;
                // const pt = As / (b * d); // 重複計算削除
                let cpt_val = Math.pow(100.0 * pt, 1.0/3.0);
                if (cpt_val < 0.7) cpt_val = 0.7; else if (cpt_val > 1.5) cpt_val = 1.5;
                res.Cpt = cpt_val;
                res.fa = allow_tauA1_base * res.Ce * res.Cpt;
                res.shearState = (Math.abs(res.tau) <= res.fa) ? 'ok' : 'ng';

            } catch(e) {
                res.state = 'error'; res.msg = e.message;
            }
            return res;
        }

        // --- 描画関数 ---
        function drawSectionDetail(elemId, s, res) {
            const el = document.getElementById(elemId);
            if(!el) return;
            // --- 修正: 寸法が空の場合は描画しない ---
            if (res.state === 'empty') {
                el.innerHTML = ''; 
                return;
            }

            const W = 200, H = 100;
            const padding = 20; 
            const rightMargin = 25; 
            
            const scaleX = (W - padding*2 - rightMargin) / s.b;
            const scaleY = (H - 20) / s.D;
            const scale = Math.min(scaleX, scaleY);
            
            const drawW = s.b * scale;
            const drawH = s.D * scale;
            
            const originX = padding; 
            const originY = (H - drawH) / 2;

            const getDia = (name) => {
                if(name.includes('D')) return parseInt(name.replace('D', '')) || 13;
                if(name.includes('φ')) return parseInt(name.replace('φ', '')) || 9;
                return 13;
            };
            // 修正: 最小サイズ制限(2.5)を撤廃し、純粋な縮尺に合わせる
            const rT = getDia(s.barSizeT) * scale / 2; 
            const rC = getDia(s.barSizeC) * scale / 2;
            const y_t = originY + drawH - s.dt * scale;
            const y_c = originY + s.dp * scale;

            const sideCover = s.dt * scale; 
            
            const makeCircles = (count, r, y, color) => {
                let svg = '';
                const cnt = Math.max(count || 0, 1);
                
                const startX = originX + sideCover;
                const endX = originX + drawW - sideCover;
                const spanW = endX - startX;

                if (cnt === 1 || !count) {
                    svg += `<circle cx="${originX + drawW/2}" cy="${y}" r="${r}" fill="${color}" stroke="white" stroke-width="0.5"/>`;
                } else {
                    const step = spanW / (cnt - 1);
                    for(let i=0; i<cnt; i++) {
                        svg += `<circle cx="${startX + step*i}" cy="${y}" r="${r}" fill="${color}" stroke="white" stroke-width="0.5"/>`;
                    }
                }
                return svg;
            };

            let svg = `<svg width="100%" height="100%" viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">`;
            svg += `<rect x="${originX}" y="${originY}" width="${drawW}" height="${drawH}" fill="#f8fafc" stroke="#475569" stroke-width="1.5"/>`;
            svg += makeCircles(s.barCountT, rT, y_t, "#dc2626");
            svg += makeCircles(s.barCountC, rC, y_c, "#16a34a");
            svg += `<text x="${originX + drawW + 5}" y="${originY + drawH/2}" font-size="9" fill="#64748b" dominant-baseline="middle" font-weight="bold">h=${s.D}</text>`;
            svg += `<text x="${originX + drawW/2}" y="${originY + drawH + 10}" font-size="9" fill="#64748b" text-anchor="middle" font-weight="bold">b=${s.b}</text>`;
            svg += `</svg>`;
            el.innerHTML = svg;
        }

        // --- データ操作・I/O ---
        function copySection1(targetIdx) {
            // 修正: confirm() が機能しない環境のため、確認なしで即コピー実行するように変更
            const src = sections[0];
            const target = sections[targetIdx];
            ['b','D','dt','dp','barSizeT','barCountT','barSizeC','barCountC','manualAs','manualAsp','Fc','n','rebarType','allowFactor','userSigSa'].forEach(k => target[k] = src[k]);
            renderAll();
        }
        function updateData(idx, key, value) {
            let val = parseFloat(value);
            if (['name', 'barSizeT', 'barSizeC', 'rebarType'].includes(key)) val = value;
            // 修正: 空文字の場合は0ではなくnullを入れる
            if (typeof val === 'number' && isNaN(val)) val = null;
            if (value === "") val = null; 

            sections[idx][key] = val;
            if (key === 'rebarType') {
                const std = REBAR_DATA[val] ? REBAR_DATA[val].sigSa : 180;
                sections[idx].userSigSa = std;
            }
            renderAll();
        }
        function saveData() {
            const blob = new Blob([JSON.stringify(sections, null, 2)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rc_sections_v3.6.json`;
            a.click();
        }
        function loadData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(Array.isArray(loaded) && loaded.length === 4) {
                        sections = loaded;
                        renderAll();
                    }
                } catch(err) { alert("形式エラー"); }
            };
            reader.readAsText(file);
        }
        function toggleHelp(show) {
            const el = document.getElementById('help_modal');
            if (show) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); } 
            else { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); }
        }
        
        // 修正: 履歴モーダル制御
        function toggleHistory(show) {
            const el = document.getElementById('history_modal');
            if (show) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); } 
            else { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 200); }
        }
        
        // --- レンダリング ---
        function renderAll() {
            const container = document.getElementById('sections_container');
            container.innerHTML = '';
            sections.forEach((sec, idx) => {
                const res = calculateRC(sec);
                const html = createSectionHTML(idx, sec, res);
                container.insertAdjacentHTML('beforeend', html);
                setTimeout(() => {
                    drawSectionDetail(`svg_section_${idx}`, sec, res);
                }, 0);
            });
            lucide.createIcons();
        }

        window.onload = function() {
            renderAll();
        };

        // --- HTML生成 (完全縦1列レイアウト・グループ強調) ---
        function createSectionHTML(idx, s, res) {
            const isErr = res.state === 'error';
            // 修正: 入力がない場合は空の状態 (state === 'empty')
            const isEmpty = res.state === 'empty';

            const makeOpts = (sel) => Object.keys(REBAR_AREAS).map(k => `<option value="${k}" ${k===sel?'selected':''}>${k}</option>`).join('');
            const makeFcOpts = (sel) => Object.keys(CONCRETE_DATA).map(k => `<option value="${k}" ${parseInt(k)===parseInt(sel)?'selected':''}>Fc${k}</option>`).join('');
            const makeRebarOpts = (sel) => Object.keys(REBAR_DATA).map(k => `<option value="${k}" ${k===sel?'selected':''}>${REBAR_DATA[k].name}</option>`).join('');
            
            // 修正: 値がnull/空の場合は '-' を表示するか空欄にするヘルパー
            const valOrEmpty = (v) => (v === null || v === undefined) ? '' : v;
            const fmt = (v, d=2) => (isEmpty || isErr || isNaN(v)) ? '' : Math.abs(v).toFixed(d); // 結果が空なら空白
            
            const getStatus = (state) => {
                if (isEmpty) return ''; // 空の場合はバッジを表示しない
                if (state === 'ng') return '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600">NG</span>';
                if (state === 'ok') return '<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-600">OK</span>';
                return '-';
            };
            let copyBtn = idx > 0 ? `<button onclick="copySection1(${idx})" class="p-1 text-slate-400 hover:text-blue-600 transition no-print" title="断面1からコピー"><i data-lucide="copy" class="w-4 h-4"></i></button>` : '';

            // せん断の詳細情報
            const shearDetail = isEmpty ? '' : `
                <div class="text-[9px] text-slate-400 mt-0.5 text-right font-mono">
                    τa1:${fmt(res.allow_tauA1_base, 2)}, Ce:${fmt(res.Ce, 2)}, Cpt:${fmt(res.Cpt, 2)}, α:${valOrEmpty(s.allowFactor)}
                </div>
            `;

            return `
            <div class="section-card bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <!-- Card Header -->
                <div class="card-header px-3 py-1.5 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                    <div class="flex items-center gap-2 w-full">
                        <span class="flex items-center justify-center w-5 h-5 bg-slate-700 text-white text-[10px] font-bold rounded-full">${idx+1}</span>
                        <input type="text" value="${s.name}" onchange="updateData(${idx}, 'name', this.value)" 
                            class="font-bold text-slate-800 bg-white border border-slate-300 rounded focus:border-blue-500 w-full text-xs px-1.5 py-0.5 placeholder-slate-400" placeholder="断面名">
                    </div>
                    ${copyBtn}
                </div>

                <div class="p-3 flex flex-col text-sm flex-1">
                    
                    <!-- Top Visual (Smaller) -->
                    <div class="h-[100px] w-full bg-white rounded border border-slate-200 flex items-center justify-center relative overflow-hidden mb-2">
                        <div id="svg_section_${idx}" class="w-full h-full"></div>
                    </div>

                    <!-- Input Area: Strictly 1 Column -->
                    <div>
                        <!-- 1. Material -->
                        <div class="mt-0">
                            <div class="section-title">材料条件</div>
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">コンクリート <span class="text-[9px] text-slate-400">(N/mm²)</span></label>
                                    <select onchange="updateData(${idx}, 'Fc', this.value)" class="input-bare w-20 text-[11px]">${makeFcOpts(s.Fc)}</select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">鉄筋種類</label>
                                    <select onchange="updateData(${idx}, 'rebarType', this.value)" class="input-bare w-20 text-[10px]">${makeRebarOpts(s.rebarType)}</select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">許容応力度 <span class="text-[9px] text-slate-400">(N/mm²)</span></label>
                                    <div class="flex items-center justify-end gap-1 w-20">
                                        <input type="number" value="${valOrEmpty(s.userSigSa)}" onchange="updateData(${idx}, 'userSigSa', this.value)" class="input-bare w-full text-blue-600">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">割増係数 (α)</label>
                                    <div class="flex items-center justify-end gap-1 w-12">
                                        <span class="text-[10px] text-slate-400">x</span>
                                        <input type="number" step="0.1" value="${valOrEmpty(s.allowFactor)}" onchange="updateData(${idx}, 'allowFactor', this.value)" class="input-bare w-full">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Geometry -->
                        <!-- 修正: section-separator クラスに加え、念のため直接スタイルを記述して区切りを強制 -->
                        <div class="section-separator" style="margin-top: 12px; padding-top: 6px; border-top: 1px solid #cbd5e1;">
                            <div class="section-title">断面形状 (mm)</div>
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">幅 b</label>
                                    <input type="number" value="${valOrEmpty(s.b)}" onchange="updateData(${idx}, 'b', this.value)" class="input-bare w-16">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">高さ h</label>
                                    <input type="number" value="${valOrEmpty(s.D)}" onchange="updateData(${idx}, 'D', this.value)" class="input-bare w-16">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">引張鉄筋位置 dt</label>
                                    <input type="number" value="${valOrEmpty(s.dt)}" onchange="updateData(${idx}, 'dt', this.value)" class="input-bare w-16">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">圧縮鉄筋位置 dp</label>
                                    <input type="number" value="${valOrEmpty(s.dp)}" onchange="updateData(${idx}, 'dp', this.value)" class="input-bare w-16">
                                </div>
                            </div>
                        </div>

                        <!-- 3. Rebar -->
                        <!-- 修正: ここも強制的に区切り線を入れる -->
                        <div class="section-separator" style="margin-top: 12px; padding-top: 6px; border-top: 1px solid #cbd5e1;">
                            <div class="section-title">配筋</div>
                            <div class="flex flex-col gap-2">
                                <div>
                                    <div class="flex items-center justify-between">
                                        <label class="label-sm text-red-500 font-bold">引張 As</label>
                                        <div class="flex items-center gap-1">
                                            <select onchange="updateData(${idx}, 'barSizeT', this.value)" class="bg-transparent border-b border-slate-300 text-[11px] font-mono py-0.5 w-12 text-right">${makeOpts(s.barSizeT)}</select>
                                            <span class="text-[10px] text-slate-400">x</span>
                                            <input type="number" value="${valOrEmpty(s.barCountT)}" onchange="updateData(${idx}, 'barCountT', this.value)" class="w-8 border-b border-slate-300 text-center font-mono text-[11px]">
                                        </div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 text-right font-mono mt-0.5 pr-1">
                                        <!-- 修正: pt表示追加 -->
                                        (${fmt(res.As_per_meter, 0)} mm²/m, pt:${fmt(res.ptPerc, 2)}%)
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center justify-between">
                                        <label class="label-sm text-green-600 font-bold">圧縮 As'</label>
                                        <div class="flex items-center gap-1">
                                            <select onchange="updateData(${idx}, 'barSizeC', this.value)" class="bg-transparent border-b border-slate-300 text-[11px] font-mono py-0.5 w-12 text-right">${makeOpts(s.barSizeC)}</select>
                                            <span class="text-[10px] text-slate-400">x</span>
                                            <input type="number" value="${valOrEmpty(s.barCountC)}" onchange="updateData(${idx}, 'barCountC', this.value)" class="w-8 border-b border-slate-300 text-center font-mono text-[11px]">
                                        </div>
                                    </div>
                                    <div class="text-[9px] text-slate-400 text-right font-mono mt-0.5 pr-1">
                                        (${fmt(res.Asp_per_meter, 0)} mm²/m)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Loads -->
                        <!-- 修正: ここも強制的に区切り線を入れる -->
                        <div class="section-separator" style="margin-top: 12px; padding-top: 6px; border-top: 1px solid #cbd5e1;">
                            <div class="section-title">断面力 (/m)</div>
                            <div class="flex flex-col gap-2">
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">曲げ M <span class="text-[9px] text-slate-400">(kN·m)</span></label>
                                    <input type="number" value="${valOrEmpty(s.M_kNm)}" onchange="updateData(${idx}, 'M_kNm', this.value)" class="input-bare w-16 font-bold">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">軸力 N <span class="text-[9px] text-slate-400">(kN)</span></label>
                                    <input type="number" value="${valOrEmpty(s.N_kN)}" onchange="updateData(${idx}, 'N_kN', this.value)" class="input-bare w-16 font-bold text-blue-600">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="label-sm">せん断 S <span class="text-[9px] text-slate-400">(kN)</span></label>
                                    <input type="number" value="${valOrEmpty(s.S_kN)}" onchange="updateData(${idx}, 'S_kN', this.value)" class="input-bare w-16 font-bold">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 区切り線（計算結果前） -->
                    <!-- 修正: styleでmargin/borderを強制指定 -->
                    <div class="section-separator" style="margin-top: 12px; padding-top: 6px; border-top: 1px solid #94a3b8;"></div>

                    <!-- Result Section (Stacked) -->
                    <div class="bg-slate-50 rounded p-2 border border-slate-200">
                        <div class="text-[11px] font-bold text-slate-700 border-b-2 border-slate-200 mb-2 pb-0.5">計算結果</div>
                        
                        <!-- Stacked Results -->
                        <div class="space-y-3">
                            <!-- Sigma C -->
                            <div>
                                <div class="flex justify-between border-b border-slate-200 pb-0.5 mb-1">
                                    <span class="text-[10px] font-bold text-slate-700">σc 曲げ圧縮 <span class="text-[9px] font-normal text-slate-400">(N/mm²)</span></span>
                                    ${getStatus(res.bendStateC)}
                                </div>
                                <div class="flex justify-between px-1">
                                    <!-- 修正: 印刷用クラス result-value-print を適用 -->
                                    <div class="text-[10px] text-slate-500">発生: <span class="font-mono font-bold text-blue-600 text-xs result-value-print">${fmt(res.sigma_c)}</span></div>
                                    <div class="text-[10px] text-slate-500">許容: <span class="font-mono text-slate-600">${fmt(res.allow_sigC, 1)}</span></div>
                                </div>
                            </div>

                            <!-- Sigma S -->
                            <div>
                                <div class="flex justify-between border-b border-slate-200 pb-0.5 mb-1">
                                    <span class="text-[10px] font-bold text-slate-700">σs 鉄筋引張 <span class="text-[9px] font-normal text-slate-400">(N/mm²)</span></span>
                                    ${getStatus(res.bendStateS)}
                                </div>
                                <div class="flex justify-between px-1">
                                    <!-- 修正: 印刷用クラス result-value-print を適用 -->
                                    <div class="text-[10px] text-slate-500">発生: <span class="font-mono font-bold text-red-600 text-xs result-value-print">${fmt(res.sigma_s, 1)}</span></div>
                                    <div class="text-[10px] text-slate-500">許容: <span class="font-mono text-slate-600">${fmt(res.allow_sigS, 0)}</span></div>
                                </div>
                            </div>

                            <!-- Tau -->
                            <div>
                                <div class="flex justify-between border-b border-slate-200 pb-0.5 mb-1">
                                    <span class="text-[10px] font-bold text-slate-700">τ せん断 <span class="text-[9px] font-normal text-slate-400">(N/mm²)</span></span>
                                    ${getStatus(res.shearState)}
                                </div>
                                <div class="flex justify-between px-1">
                                    <!-- 修正: 印刷用クラス result-value-print を適用 -->
                                    <div class="text-[10px] text-slate-500">発生: <span class="font-mono font-bold text-slate-700 text-xs result-value-print">${fmt(res.tau, 3)}</span></div>
                                    <div class="text-[10px] text-slate-500">許容: <span class="font-mono text-slate-600">${fmt(res.fa, 3)}</span></div>
                                </div>
                                ${shearDetail}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }
    </script>
</body>
</html>
